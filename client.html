<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×¦'××˜ ××©×—×§×™× ××ª×§×“×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary-color: #4a6fa5;
      --primary-dark: #3d5a80;
      --primary-light: #6c8fc7;
      --accent-color: #4caf50;
      --accent-dark: #388e3c;
      --background-color: #f5f7fa;
      --card-color: #ffffff;
      --text-color: #333333;
      --border-radius: 8px;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    h2, h3 {
      color: var(--primary-dark);
      text-align: center;
      margin-bottom: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background-color: var(--card-color);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--primary-dark);
    }

    input, button, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      font-size: 1rem;
      margin-bottom: 10px;
    }

    button {
      background-color: var(--accent-color);
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: var(--accent-dark);
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #status {
      text-align: center;
      padding: 8px;
      margin: 15px 0;
      border-radius: var(--border-radius);
      font-weight: bold;
    }

    .status-connecting {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
    }

    .status-connected {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    #chat-area {
      display: none;
      margin-top: 20px;
    }

    #message-container {
      height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      border-radius: 18px;
      display: inline-block;
      max-width: 80%;
      word-wrap: break-word;
    }

    .system-message {
      background-color: #e1e1e1;
      color: #666;
      text-align: center;
      margin: 10px auto;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9rem;
      display: block;
    }

    .my-message {
      background-color: var(--primary-light);
      color: white;
      margin-left: auto;
      border-bottom-right-radius: 5px;
    }

    .other-message {
      background-color: var(--card-color);
      border: 1px solid #ddd;
      margin-right: auto;
      border-bottom-left-radius: 5px;
    }
    
    .sender-name {
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 2px;
      display: block;
    }

    .message-row {
      display: flex;
      margin-bottom: 10px;
      position: relative;
      clear: both;
    }

    #spinner {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid var(--primary-color);
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ×—×œ×§ ×¡×™××•×œ×¦×™×™×ª ×”××©×—×§ */
    #game-demo {
      margin-top: 20px;
      padding: 15px;
      border: 2px dashed var(--primary-color);
      border-radius: var(--border-radius);
      background-color: rgba(74, 111, 165, 0.1);
    }

    .game-title {
      color: var(--primary-dark);
      text-align: center;
      margin-bottom: 10px;
    }

    .game-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .game-controls button {
      flex: 1;
      min-width: 120px;
    }

    .game-display {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 15px;
      min-height: 100px;
      text-align: center;
    }

    .game-status {
      margin-top: 10px;
      font-style: italic;
      text-align: center;
      color: var(--primary-color);
    }

    /* ×”×’×“×¨×•×ª ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      .message {
        max-width: 90%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>ğŸ’¬ ×¦'××˜ ××©×—×§×™× ××ª×§×“×</h2>
      
      <!-- ×˜×•×¤×¡ ×”×ª×—×‘×¨×•×ª -->
      <div id="login-form">
        <div class="form-group">
          <label for="username">×©× ××©×ª××©:</label>
          <input type="text" id="username" placeholder="×”×›× ×¡ ××ª ×©××š" autocomplete="off" />
        </div>
        
        <div class="form-group">
          <label for="room">×©× ×—×“×¨:</label>
          <input type="text" id="room" placeholder="×”×›× ×¡ ×©× ×—×“×¨" autocomplete="off" value="×—×“×¨1" />
        </div>
        
        <button id="connect-btn">×”×ª×—×‘×¨ ×œ×—×“×¨</button>
      </div>
      
      <div id="status" class="status-connecting">×××ª×™×Ÿ ×œ×—×™×‘×•×¨...</div>
      
      <div id="spinner">
        <div class="loader"></div>
        <span>×”×©×¨×ª ××ª×¢×•×¨×¨... ×–×” ×¢×œ×•×œ ×œ×§×—×ª ×›×—×¦×™ ×“×§×” â³</span>
      </div>
      
      <!-- ××–×•×¨ ×”×¦'××˜ -->
      <div id="chat-area">
        <div id="message-container"></div>
        
        <div class="form-group">
          <input type="text" id="message-input" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." autocomplete="off" />
          <button id="send-btn">×©×œ×—</button>
        </div>
        
        <!-- ×“××• ×œ××©×—×§ -->
        <div id="game-demo">
          <h3 class="game-title">ğŸ® ×¡×™××•×œ×¦×™×™×ª ××©×—×§</h3>
          <p>×–×• ×“×•×’××” ×œ××™× ×˜×’×¨×¦×™×” ×©×œ ×× ×’× ×•×Ÿ ×”×¦'××˜ ×¢× ××©×—×§. ×‘×“×•×’××” ×–×• × ×™×ª×Ÿ ×œ×”×¢×‘×™×¨ ×¡×˜×˜×•×¡ ×‘×¡×™×¡×™ ×‘×™×Ÿ ×”××©×ª×ª×¤×™×.</p>
          
          <div class="game-controls">
            <button id="game-btn1">×¢×“×›×Ÿ × ×™×§×•×“ ğŸ†</button>
            <button id="game-btn2">×‘×—×¨ ×¦×‘×¢ ğŸ¨</button>
          </div>
          
          <div class="game-display">××™×“×¢ ×¢×œ ×”××©×—×§ ×™×•×¤×™×¢ ×›××Ÿ</div>
          
          <div class="game-status">×××ª×™×Ÿ ×œ××”×œ×š ××©×—×§...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ××•×“×•×œ ×ª×§×©×•×¨×ª -->
  <script>
    /**
     * GameConnection
     * ××•×“×•×œ ×§×œ×™×™× ×˜ ×œ×ª×§×©×•×¨×ª WebSocket ×¢×‘×•×¨ ××©×—×§×™× ×•××¤×œ×™×§×¦×™×•×ª ×¦'××˜
     */
    class GameConnection {
      /**
       * ×™×¦×™×¨×ª ×—×™×‘×•×¨ ×—×“×©
       * @param {string} serverUrl - ×›×ª×•×‘×ª ×©×¨×ª ×”-WebSocket
       */
      constructor(serverUrl) {
        this.socket = null;
        this.serverUrl = serverUrl;
        this.room = '';
        this.username = '';
        this.connected = false;
        
        // ×××–×™× ×™× ×œ××™×¨×•×¢×™×
        this.listeners = {
          onConnect: null,      // ×‘×¢×ª ×”×ª×—×‘×¨×•×ª
          onDisconnect: null,   // ×‘×¢×ª × ×™×ª×•×§
          onError: null,        // ×‘×¢×ª ×©×’×™××”
          onTextMessage: null,  // ×‘×¢×ª ×§×‘×œ×ª ×”×•×“×¢×ª ×˜×§×¡×˜
          onStatusUpdate: null, // ×‘×¢×ª ×§×‘×œ×ª ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡
          onHistory: null       // ×‘×¢×ª ×§×‘×œ×ª ×”×™×¡×˜×•×¨×™×”
        };
        
        // ××™× ×“×™×§×˜×•×¨ ×”×× ×”×©×¨×ª ×‘×ª×”×œ×™×š ×”×ª×¢×•×¨×¨×•×ª
        this.serverWakingUp = false;
      }
      
      /**
       * ×”×ª×—×‘×¨×•×ª ×œ×©×¨×ª ×•×”×¦×˜×¨×¤×•×ª ×œ×—×“×¨
       * @param {string} username - ×©× ×”××©×ª××©
       * @param {string} room - ××–×”×” ×”×—×“×¨
       * @returns {Promise} ×”×‘×˜×—×” ×©××ª×××©×ª ×‘×¢×ª ×”×ª×—×‘×¨×•×ª
       */
      connect(username, room) {
        return new Promise((resolve, reject) => {
          if (!username || !room) {
            reject(new Error('×©× ××©×ª××© ×•×—×“×¨ ×”× ×©×“×•×ª ×—×•×‘×”'));
            return;
          }
          
          this.room = room;
          this.username = username;
          this.serverWakingUp = false;
          
          // ×¡×’×™×¨×ª ×—×™×‘×•×¨ ×§×•×“× ×× ×§×™×™×
          if (this.socket && this.socket.readyState !== WebSocket.CLOSED) {
            this.socket.close();
          }
          
          try {
            this.socket = new WebSocket(this.serverUrl);
            
            // ×˜×™×™××××•×˜ ×œ×”×ª×¢×•×¨×¨×•×ª ×”×©×¨×ª
            const wakeupTimeout = setTimeout(() => {
              if (!this.connected) {
                this.serverWakingUp = true;
                if (this.listeners.onStatusUpdate) {
                  this.listeners.onStatusUpdate('waking-up');
                }
              }
            }, 3000);
            
            this.socket.onopen = () => {
              clearTimeout(wakeupTimeout);
              this.connected = true;
              this.serverWakingUp = false;
              
              // ×©×œ×™×—×ª ×”×•×“×¢×ª ×”×¦×˜×¨×¤×•×ª ×œ×—×“×¨
              this.socket.send(JSON.stringify({
                type: 'JOIN',
                room: this.room,
                sender: this.username
              }));
              
              if (this.listeners.onConnect) {
                this.listeners.onConnect();
              }
              
              resolve();
            };
            
            this.socket.onclose = () => {
              clearTimeout(wakeupTimeout);
              this.connected = false;
              
              if (this.listeners.onDisconnect) {
                this.listeners.onDisconnect();
              }
            };
            
            this.socket.onerror = (error) => {
              clearTimeout(wakeupTimeout);
              
              if (this.listeners.onError) {
                this.listeners.onError(error);
              }
              
              reject(error);
            };
            
            this.socket.onmessage = (event) => {
              try {
                const data = JSON.parse(event.data);
                
                // ×˜×™×¤×•×œ ×‘×¡×•×’×™ ×”×”×•×“×¢×•×ª ×”×©×•× ×™×
                switch (data.type) {
                  case 'TEXT':
                    if (this.listeners.onTextMessage) {
                      this.listeners.onTextMessage(data);
                    }
                    break;
                    
                  case 'STATUS':
                    if (this.listeners.onStatusUpdate) {
                      this.listeners.onStatusUpdate(data);
                    }
                    break;
                    
                  case 'HISTORY':
                    if (this.listeners.onHistory) {
                      this.listeners.onHistory(data.content);
                    }
                    break;
                }
              } catch (error) {
                console.error('×©×’×™××” ×‘×¤×¢× ×•×— ×”×•×“×¢×”:', error);
              }
            };
            
          } catch (error) {
            reject(error);
          }
        });
      }
      
      /**
       * ×©×œ×™×—×ª ×”×•×“×¢×ª ×˜×§×¡×˜ ×œ×—×“×¨
       * @param {string} text - ×ª×•×›×Ÿ ×”×˜×§×¡×˜
       */
      sendTextMessage(text) {
        if (!this.connected || !this.socket) {
          throw new Error('×œ× ××—×•×‘×¨ ×œ×©×¨×ª');
        }
        
        this.socket.send(JSON.stringify({
          type: 'TEXT',
          room: this.room,
          sender: this.username,
          content: text
        }));
      }
      
      /**
       * ×©×œ×™×—×ª ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××©×—×§ ×œ×›×œ ×”××©×ª×ª×¤×™× ×‘×—×“×¨
       * @param {any} statusData - ××™×“×¢ ×¡×˜×˜×•×¡ ×œ×©×œ×™×—×”
       */
      sendGameStatus(statusData) {
        if (!this.connected || !this.socket) {
          throw new Error('×œ× ××—×•×‘×¨ ×œ×©×¨×ª');
        }
        
        this.socket.send(JSON.stringify({
          type: 'STATUS',
          room: this.room,
          sender: this.username,
          content: statusData
        }));
      }
      
      /**
       * × ×™×ª×•×§ ××”×©×¨×ª
       */
      disconnect() {
        if (this.socket) {
          this.socket.close();
        }
        
        this.connected = false;
      }
      
      /**
       * ×”×’×“×¨×ª ×××–×™×Ÿ ×œ××™×¨×•×¢
       * @param {string} event - ×¡×•×’ ×”××™×¨×•×¢
       * @param {Function} callback - ×¤×•× ×§×¦×™×™×ª ×§×•×œ×‘×§
       */
      on(event, callback) {
        if (this.listeners.hasOwnProperty(event)) {
          this.listeners[event] = callback;
        } else {
          console.warn(`××™×¨×•×¢ ×œ× ××•×›×¨: ${event}`);
        }
      }
    }

    // ×§×•×“ ×œ×”×¤×¢×œ×ª ×”×××©×§
    document.addEventListener('DOMContentLoaded', function() {
      // ××œ×× ×˜×™× ×‘×××©×§
      const loginForm = document.getElementById('login-form');
      const usernameInput = document.getElementById('username');
      const roomInput = document.getElementById('room');
      const connectBtn = document.getElementById('connect-btn');
      const statusDiv = document.getElementById('status');
      const spinnerDiv = document.getElementById('spinner');
      const chatArea = document.getElementById('chat-area');
      const messageContainer = document.getElementById('message-container');
      const messageInput = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      const gameBtn1 = document.getElementById('game-btn1');
      const gameBtn2 = document.getElementById('game-btn2');
      const gameDisplay = document.querySelector('.game-display');
      const gameStatus = document.querySelector('.game-status');
      
      // ×™×¦×™×¨×ª ×—×™×‘×•×¨ ×œ×©×¨×ª
      const connection = new GameConnection('wss://chat-server-kqi4.onrender.com');
      
      // ××©×ª× ×™× ×œ×“×•×’××ª ×”××©×—×§
      let gameScore = 0;
      let gameColor = '#4a6fa5';
      
      // ×”×•×¡×¤×ª ×”×•×“×¢×” ×œ×××©×§
      function addMessage(message, isSystem = false) {
        const messageElem = document.createElement('div');
        
        if (isSystem) {
          messageElem.className = 'system-message';
          messageElem.textContent = message;
        } else {
          const messageRow = document.createElement('div');
          messageRow.className = 'message-row';
          
          messageElem.className = message.sender === connection.username ? 'message my-message' : 'message other-message';
          
          if (message.sender !== connection.username) {
            const senderElem = document.createElement('span');
            senderElem.className = 'sender-name';
            senderElem.textContent = message.sender;
            messageElem.appendChild(senderElem);
          }
          
          const contentElem = document.createElement('div');
          contentElem.textContent = message.content;
          messageElem.appendChild(contentElem);
          
          messageRow.appendChild(messageElem);
          messageContainer.appendChild(messageRow);
          
          // ×’×œ×™×œ×” ×œ×ª×—×ª×™×ª
          messageContainer.scrollTop = messageContainer.scrollHeight;
          return;
        }
        
        messageContainer.appendChild(messageElem);
        messageContainer.scrollTop = messageContainer.scrollHeight;
      }
      
      // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”××©×—×§
      function updateGameDisplay() {
        gameDisplay.innerHTML = `
          <div style="color: ${gameColor}; font-size: 1.2em; margin-bottom: 8px;">
            <strong>× ×™×§×•×“ × ×•×›×—×™: ${gameScore}</strong>
          </div>
          <div>×¦×‘×¢ × ×‘×—×¨: <span style="display: inline-block; width: 20px; height: 20px; background-color: ${gameColor}; vertical-align: middle; border: 1px solid #ccc;"></span></div>
        `;
      }
      
      // ×××–×™× ×™× ×œ××™×¨×•×¢×™ ×”×—×™×‘×•×¨
      connection.on('onConnect', () => {
        statusDiv.textContent = 'âœ… ××—×•×‘×¨ ×œ×©×¨×ª';
        statusDiv.className = 'status-connected';
        spinnerDiv.style.display = 'none';
        loginForm.style.display = 'none';
        chatArea.style.display = 'block';
        
        addMessage('×”×ª×—×‘×¨×ª ×œ×¦\'××˜ ×‘×”×¦×œ×—×”!', true);
      });
      
      connection.on('onDisconnect', () => {
        statusDiv.textContent = 'âŒ × ×•×ª×§×ª ××”×©×¨×ª';
        statusDiv.className = 'status-error';
        loginForm.style.display = 'block';
        chatArea.style.display = 'none';
      });
      
      connection.on('onError', (error) => {
        statusDiv.textContent = 'âŒ ×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª';
        statusDiv.className = 'status-error';
        spinnerDiv.style.display = 'none';
        console.error('×©×’×™××ª ×—×™×‘×•×¨:', error);
      });
      
      connection.on('onStatusUpdate', (data) => {
        if (data === 'waking-up') {
          // ×”×©×¨×ª ×‘×ª×”×œ×™×š ×”×ª×¢×•×¨×¨×•×ª
          spinnerDiv.style.display = 'flex';
          return;
        }
        
        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ××©×—×§
        try {
          if (data && data.content) {
            const status = data.content;
            
            if (status.type === 'score') {
              gameScore = status.value;
              gameStatus.textContent = `${data.sender} ×¢×“×›×Ÿ ××ª ×”× ×™×§×•×“ ×œ-${status.value}`;
            } else if (status.type === 'color') {
              gameColor = status.value;
              gameStatus.textContent = `${data.sender} ×‘×—×¨ ×¦×‘×¢ ×—×“×©`;
            }
            
            updateGameDisplay();
          }
        } catch (e) {
          console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×¡×˜×˜×•×¡:', e);
        }
      });
      
      connection.on('onTextMessage', (message) => {
        addMessage(message);
      });
      
      connection.on('onHistory', (messages) => {
        // ×”×•×¡×¤×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª
        addMessage('×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª:', true);
        messages.forEach(message => {
          addMessage(message);
        });
        addMessage('×¡×•×£ ×”×™×¡×˜×•×¨×™×”', true);
      });
      
      // ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª
      connectBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        const room = roomInput.value.trim();
        
        if (!username || !room) {
          alert('× × ×œ×”×–×™×Ÿ ×©× ××©×ª××© ×•×©× ×—×“×¨');
          return;
        }
        
        statusDiv.textContent = '××ª×—×‘×¨ ×œ×©×¨×ª...';
        statusDiv.className = 'status-connecting';
        
        connection.connect(username, room)
          .catch(error => {
            console.error('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª:', error);
            statusDiv.textContent = '×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª';
            statusDiv.className = 'status-error';
          });
      });
      
      // ×©×œ×™×—×ª ×”×•×“×¢×”
      function sendMessage() {
        const text = messageInput.value.trim();
        if (text) {
          try {
            connection.sendTextMessage(text);
            messageInput.value = '';
          } catch (error) {
            alert('×©×’×™××” ×‘×©×œ×™×—×ª ×”×”×•×“×¢×”: ' + error.message);
          }
        }
      }
      
      // ×›×¤×ª×•×¨ ×©×œ×™×—×ª ×”×•×“×¢×”
      sendBtn.addEventListener('click', sendMessage);
      
      // ×©×œ×™×—×” ×‘×œ×—×™×¦×” ×¢×œ Enter
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
      
      // ×›×¤×ª×•×¨×™ ×”××©×—×§
      gameBtn1.addEventListener('click', () => {
        gameScore += 10;
        updateGameDisplay();
        
        connection.sendGameStatus({
          type: 'score',
          value: gameScore
        });
        
        gameStatus.textContent = '×¢×“×›× ×ª ××ª ×”× ×™×§×•×“';
      });
      
      gameBtn2.addEventListener('click', () => {
        // ×‘×—×™×¨×ª ×¦×‘×¢ ×¨× ×“×•××œ×™
        const colors = ['#4a6fa5', '#4caf50', '#e91e63', '#ff9800', '#9c27b0', '#795548'];
        const newColor = colors[Math.floor(Math.random() * colors.length)];
        gameColor = newColor;
        
        updateGameDisplay();
        
        connection.sendGameStatus({
          type: 'color',
          value: newColor
        });
        
        gameStatus.textContent = '×‘×—×¨×ª ×¦×‘×¢ ×—×“×©';
      });
      
      // ×¢×“×›×•×Ÿ ×¨××©×•× ×™ ×©×œ ×ª×¦×•×’×ª ×”××©×—×§
      updateGameDisplay();
    });
  </script>
</body>
</html>
